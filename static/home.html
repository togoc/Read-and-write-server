<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="static/css/com.css">
    <title>home</title>
</head>

<body>
    <!-- 显示地址 -->
    <div class="location">
        <h4>asdd</h4>
    </div>
    <!-- 底部控制 -->
    <div class="control">
        <div class="control_layout">
            <input type="button" value="上一页">
            <input type="button" value="上传文件">
            <input type="button" value="主页">
        </div>
    </div>
    <!-- 视频播放器 -->
    <div class="player">
        <div class="close"><img src="static/images/exit.png" alt=""></div>
        <video src="" autoplay controls></video>
    </div>
    <!-- 插入文件列表 -->
    <div class="doc_list">
        <div class="doc">
            <img src="static/images/file.png" alt="">
            <a href="#音乐">音乐</a>
        </div>
    </div>
    <!-- 背景高斯模糊 -->
    <div class="blur">
        <div></div>
        <div></div>
    </div>
    <!-- 上传文件 -->
    <div class="postfile ">
        <div class="close_post"><img src="static/images/exit.png" alt=""></div>
        <label>当前夹<input type="checkbox" class="this_file"><span class="post_index">11</span></label>
        <div class="postFile_style">
            <form enctype="multipart/form-data" action="#" class="formdata">
                <input class="gua" type="file" name="name" value="tgc">
                <input type="button" name="sum" class="sentfile" value="上传">
            </form>
        </div>
    </div>
</body>
<script src="static/js/juqery_3.4.1.js"></script>
<script>
    var callback
    var lastPosition = []
    var lastFile
    function changeHash(str) {

        window.history.replaceState(null, null, 'home');
        // window.history.pushState(null, null, 'home');
        fix(callback.files);
        // var arr = str.split('\\');
        // location.hash = 'd:\\' + arr[1]
        location.hash = str
        $('.location h4').html(decodeURIComponent(location.hash));
        lastPosition.push(callback.index);
    }

    function prev() {
        console.log(callback)
        if (callback.index.indexOf('/'))
            lastFile = callback.index.slice(callback.index.lastIndexOf('/'))

        if (callback.index == callback.home)
            lastFile = 0

        if (callback.index != callback.home && callback.index.indexOf('/') == -1)
            lastFile = (callback.index.split('\\'))[1]


        $.ajax({ url: '/read?prev=' + lastFile }).done(function (res) {
            callback = res
            changeHash(callback.index)
        })
    }



    function fix(arr) {
        var t = ''
        function addFiles(arr) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].indexOf('.') == -1) {
                    t += `
                <div class="doc">
                    <img src="static/images/file.png" alt="">
                    <a href="#${arr[i]}">${arr[i]}</a>
                </div>
                `
                }
            }
        }

        function addMp4(arr) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].indexOf('.') != -1 && (arr[i].split('.').pop() == 'mp4' || arr[i].split('.').pop() == 'avi')) {
                    t += `
                <div class="doc">
                    <img src="static/images/video.png" alt="">
                    <a href="#${arr[i]}">${arr[i]}</a>
                    <a href="${(callback.index).slice(callback.index.indexOf('\\'))}\\${arr[i]}" download="${arr[i]}">点击下载</a>
                </div>
                `
                }
            }
        }
        function addUnknowFile(arr) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].indexOf('.') != -1 && arr[i].split('.').pop() != 'mp4' && arr[i].split('.').pop() != 'avi') {
                    t += `
                <div class="doc">
                    <img src="static/images/unknow.png" alt="">
                    <a href="#${arr[i]}">${arr[i]}</a>
                </div>
                
                `
                }
            }
        }

        addFiles(arr);
        addMp4(arr);
        addUnknowFile(arr);
        $('.doc_list').html(t)
        getData()
    }



    function getData() {
        $('.doc a:first-of-type').click(function (e) {
            var oevent = e || event
            if (oevent.preventDefault) {
                oevent.preventDefault()
            } else {
                oevent.returnValue = false
            }

            var str = ["c:", "Users", "togoc", "Desktop", "Read_and_write_server/static"]
            str[-1]

            if ($(this).html().indexOf('.') == -1) {
                var url = $(this).html()
                $.ajax({ url: '/read?code=/' + url }).done(function (res) {
                    callback = res
                    changeHash(callback.index)
                })
            } else {
                $('.player').toggleClass('show');
                $('.blur').toggleClass('show1');
                document.querySelector('video').src =(callback.index.split('Read_and_write_server')).pop() + '/' + $(this).html()
            }
        })
        $('.close').click(function () {
            $('.player').removeClass('show')
            $('.blur').removeClass('show1')
            document.querySelector('video').src = ''
        })

    }

    function addPost() {
        $('.post_index').html(callback.index)
        $('.blur').toggleClass('show1');
        $('.postfile').toggleClass('show1');
        $('.close_post').click(function () {
            $('.postfile').removeClass('show1');
            $('.blur').removeClass('show1');
        })
    }
    var this_file = document.querySelector('.this_file')
    function postFile() {
        var url
        var this_file = document.querySelector('.this_file')
        if (this_file.checked) {
            url = 'formdata?index=' + callback.index
        } else {
            url = 'formdata'
        }

        console.log(data)
        $.post({
            method: 'post',
            url: url,
            data: new FormData(document.querySelector('.formdata')),
            processData: false,
            contentType: false,
            cache: false
        }).done(function (res) {
            if (res.msg) {
                alert('上传成功!')
            } else {
                alert('上传错误,请查看控制台详细内容');
                console.log(res)
            }
        })
    }


    window.addEventListener('popstate', function () {
        if (location.hash == '') {
            location.reload()
            // // prev()   
            // // lastPosition.pop()
            // $.ajax({ url: '/read?back=' + lastPosition[lastPosition.length - 1] }).done(function (res) {
            //     callback = res
            //     changeHash(callback.index)
            // })
            // console.log(lastPosition)
        }
    })



    window.onload = function () {
        $.ajax({ url: '/homepage' }).done(function (res) {
            callback = res;
            changeHash(callback.index)
        })
        $('.control input[type=button]:first-of-type').click(function () {
            prev()
        });
        $('.control input[type=button]:nth-of-type(2)').click(function () {
            addPost()
        });
        $('.control input[type=button]:last-of-type').click(function () {
            location.reload()

        });
        $('.sentfile').click(function () {
            postFile()
        });

        getData();

    }






</script>
<script>
    var data = new FormData(document.querySelector('.formdata'))

    $('.gua').change(function () {
        console.log($(this).val())//C:\fakepath\+文件名
    })



</script>

</html>